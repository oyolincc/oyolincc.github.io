<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebpackåŸç†</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.47ef6698.js" as="script"><link rel="preload" href="/assets/js/2.6d8ae55b.js" as="script"><link rel="preload" href="/assets/js/5.26e38a66.js" as="script"><link rel="prefetch" href="/assets/js/10.f387a10f.js"><link rel="prefetch" href="/assets/js/11.c1b4cb0b.js"><link rel="prefetch" href="/assets/js/12.5c9e598e.js"><link rel="prefetch" href="/assets/js/13.537bc5a1.js"><link rel="prefetch" href="/assets/js/14.9ede1c62.js"><link rel="prefetch" href="/assets/js/15.a28880a7.js"><link rel="prefetch" href="/assets/js/16.5466c073.js"><link rel="prefetch" href="/assets/js/17.65bdf248.js"><link rel="prefetch" href="/assets/js/3.924945c2.js"><link rel="prefetch" href="/assets/js/4.5fa47ea8.js"><link rel="prefetch" href="/assets/js/6.adbc6dbc.js"><link rel="prefetch" href="/assets/js/7.d1d73f47.js"><link rel="prefetch" href="/assets/js/8.2b10522a.js"><link rel="prefetch" href="/assets/js/9.87a41797.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">å‰ç«¯å°è®°</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ç«¯å¤–åŸºç¡€</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/basis/protocol/" class="sidebar-link">äº’è”ç½‘åè®®</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æ ¸å¿ƒå‰ç«¯</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>HTML &amp; CSS</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/core/html-css/basis/" class="sidebar-link">æ ·å¼åŸºç¡€</a></li><li><a href="/core/html-css/css3/" class="sidebar-link">CSS3</a></li><li><a href="/core/html-css/layout/" class="sidebar-link">å¸¸è§å¸ƒå±€</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å‰ç«¯å·¥ç¨‹</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/development/build/webpack/" aria-current="page" class="active sidebar-link">WebpackåŸç†</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/development/build/webpack/#webpack-4-è¿ä½œåŸç†" class="sidebar-link">Webpack 4 è¿ä½œåŸç†</a></li><li class="sidebar-sub-header"><a href="/development/build/webpack/#webpack-5-ä¸-webpack-4-å¯¹æ¯”" class="sidebar-link">Webpack 5 ä¸ Webpack 4 å¯¹æ¯”</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å‰ç«¯æ¡†æ¶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/framework/vue/source/" class="sidebar-link">VUE2 æºç åˆ†æ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node.js</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-js/server/http/" class="sidebar-link">Node.jsä¸­æ­å»ºHTTPæœåŠ¡å™¨</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpackåŸç†"><a href="#webpackåŸç†" class="header-anchor">#</a> WebpackåŸç†</h1> <h2 id="webpack-4-è¿ä½œåŸç†"><a href="#webpack-4-è¿ä½œåŸç†" class="header-anchor">#</a> Webpack 4 è¿ä½œåŸç†</h2> <h3 id="tapableäº‹ä»¶æœºåˆ¶"><a href="#tapableäº‹ä»¶æœºåˆ¶" class="header-anchor">#</a> Tapableäº‹ä»¶æœºåˆ¶</h3> <p>æèµ·webpackå·¥ä½œæœºåˆ¶ä¸å¾—ä¸ætapableï¼Œå®ƒæ˜¯wabpackå†…éƒ¨è¡ç”Ÿå‡ºæ¥çš„åº“ï¼Œè´Ÿè´£ä¸€ç³»åˆ—ç›‘å¬å‡½æ•°çš„è°ƒåº¦ã€‚å¯ä»¥ç†è§£ä¸ºåœ¨å‘å¸ƒ- è®¢é˜…æ¨¡å¼åŸºç¡€ä¸Šé’ˆå¯¹ç‰¹å®šçš„åœºæ™¯è¿›è¡Œäº†å¢å¼ºã€‚å¯å‚è§<a href="https://github.com/webpack/tapable" target="_blank">githubä»“åº“</a>ã€‚</p> <p>å¯ä»¥é€šè¿‡tap/tapAsync/tapPromiseæ–¹æ³•åœ¨ä¸åŒé’©å­ä¸Šæ³¨å†Œç›‘å¬å‡½æ•°ï¼Œå†ç”¨call/callAsync/callPromiseè°ƒç”¨ï¼Œä¾‹ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'info'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'event1: '</span> <span class="token operator">+</span> info<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'haha'</span><span class="token punctuation">)</span> <span class="token comment">// event1: haha</span>
</code></pre></div><p>åœ¨tapableä¸­ä¸€å…±æœ‰å¦‚ä¸‹çš„Hookï¼š</p> <table><thead><tr><th>Hookåç§°</th> <th>æ‰§è¡Œæ–¹å¼</th> <th>æ‰§è¡Œç‰¹ç‚¹</th></tr></thead> <tbody><tr><td>SyncHook</td> <td>åŒæ­¥ä¸²è¡Œ</td> <td>ä¸å…³å¿ƒç›‘å¬å‡½æ•°çš„è¿”å›å€¼</td></tr> <tr><td>SyncBailHook</td> <td>åŒæ­¥ä¸²è¡Œ</td> <td>åªè¦ç›‘å¬å‡½æ•°ä¸­æœ‰ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ä¸ä¸º undefinedï¼Œåˆ™è·³è¿‡å‰©ä¸‹æ‰€æœ‰çš„é€»è¾‘</td></tr> <tr><td>SyncWaterfallHook</td> <td>åŒæ­¥ä¸²è¡Œ</td> <td>ä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„è¿”å›å€¼å°†ä½œä¸ºå‚æ•°ä¼ ç»™ä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°</td></tr> <tr><td>SyncLoopHook</td> <td>åŒæ­¥å¾ªç¯</td> <td>å½“ç›‘å¬å‡½æ•°è¢«è§¦å‘æ—¶ï¼Œå¦‚æœè¯¥ç›‘å¬å‡½æ•°è¿”å›ç±»trueå€¼åˆ™è¿™ä¸ªç›‘å¬å‡½æ•°ä¼šåå¤æ‰§è¡Œï¼Œå¦åˆ™è¡¨ç¤ºé€€å‡ºå¾ªç¯</td></tr> <tr><td>AsyncParallelHook</td> <td>å¼‚æ­¥å¹¶å‘</td> <td>ä¸å…³å¿ƒcallbackçš„ä¼ å€¼</td></tr> <tr><td>AsyncParallelBailHook</td> <td>å¼‚æ­¥å¹¶å‘</td> <td>åªè¦callbackä¸­æœ‰ä¸€ä¸ªä¼ å€¼ä¸ºç±»çœŸå€¼ï¼Œåˆ™ç›´æ¥è·³åˆ°callAsyncç»‘å®šçš„å›è°ƒå‡½æ•°å¹¶ç­‰æ­£åœ¨æ‰§è¡Œçš„ç›‘å¬å‡½æ•°å…¨éƒ¨æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ</td></tr> <tr><td>AsyncSeriesHook</td> <td>å¼‚æ­¥ä¸²è¡Œ</td> <td>ä¸å…³å¿ƒcallbackçš„ä¼ å€¼</td></tr> <tr><td>AsyncSeriesBailHook</td> <td>å¼‚æ­¥ä¸²è¡Œ</td> <td>åªè¦callbackä¸­æœ‰ä¸€ä¸ªä¼ å€¼ä¸ºç±»çœŸå€¼ï¼Œå°±ä¼šè·³åˆ°callAsyncç»‘å®šçš„å›è°ƒå‡½æ•°æ‰§è¡Œ</td></tr> <tr><td>AsyncSeriesWaterfallHook</td> <td>å¼‚æ­¥ä¸²è¡Œ</td> <td>ä¸Šä¸€ä¸ªç›‘å¬å‡½æ•°çš„callbackä¼ å€¼ä¼šä½œä¸ºä¸‹ä¸€ä¸ªç›‘å¬å‡½æ•°çš„å‚æ•°</td></tr> <tr><td>AsyncSeriesLoopHook</td> <td>å¼‚æ­¥å¾ªç¯</td> <td>ç±»ä¼¼SyncLoopHook</td></tr></tbody></table> <p>é€šè¿‡é˜…è¯»æºç å¯çŸ¥ï¼Œæ‰€æœ‰Hookç±»éƒ½ç»§æ‰¿è‡ªåŸºç±»Hookï¼Œä¸”å…¶ä¸­tapæ–¹æ³•å®é™…ä¸Šæ˜¯è°ƒç”¨äº†å†…éƒ¨_insertæ–¹æ³•æ³¨å†Œäº‹ä»¶ï¼Œä¸”tapçš„optionå®é™…ä¸Šå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code>hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'ev'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token comment">// ä»¥ä¸Šå†™æ³•å°†è½¬æ¢ä¸º</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'ev'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 

<span class="token comment">/*
ä¸”æ¥å—beforeå’Œstageå­—æ®µï¼š
beforeï¼šä»£è¡¨æœ¬æ¬¡ç›‘å¬å›è°ƒæ‰§è¡Œé¡ºåºå°†åœ¨nameä¸ºè¯¥å€¼çš„å›è°ƒä¹‹å‰å°±è¿‘çš„ä¸”æ»¡è¶³stageè§„å¾‹çš„ä½ç½®ï¼›
stageï¼šå€˜è‹¥å­˜åœ¨stageå­—æ®µ(é»˜è®¤è§†ä¸º0), åˆ™å°çš„stageä¼šåœ¨å¤§stageå‰é¢ï¼Œç›¸ç­‰çš„stageåæ¥çš„åœ¨å‰é¢ã€‚
*/</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'ev2'</span><span class="token punctuation">,</span> before<span class="token operator">:</span> <span class="token string">'ev'</span><span class="token punctuation">,</span> stage<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
</code></pre></div><p><img src="/assets/img/tapable-1.ed2e219c.png" alt="tapableæ³¨å†Œäº‹ä»¶"></p> <p>é€šè¿‡tapableï¼Œå¯ä»¥å°†å¤æ‚çš„ä»»åŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªå°äº‹ä»¶è°ƒç”¨ã€‚æ¯”å¦‚ä»¥ä¸‹ä¾‹å­ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook<span class="token punctuation">,</span> SyncWaterfallHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tapable'</span><span class="token punctuation">)</span>
<span class="token comment">/**
 * åšèœ
 *   ä¹°èœ
 *   æ´—èœ
 *    æ´—ç¬¬ä¸€é
 *    æ´—ç¬¬äºŒé
 *   åˆ‡èœ
 *   ç…®èœ
 * åƒèœ
 */</span>
<span class="token keyword">function</span> <span class="token function">takeFood</span><span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
    makeFood<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'food'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    eatFood<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'food'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  hooks<span class="token punctuation">.</span>makeFood<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'buy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ä¹°'</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">)</span>
  hooks<span class="token punctuation">.</span>makeFood<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'wash'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> washHooks <span class="token operator">=</span> <span class="token punctuation">{</span>
      first<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'food'</span><span class="token punctuation">,</span> <span class="token string">'waterConsumption'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      second<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncWaterfallHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'food'</span><span class="token punctuation">,</span> <span class="token string">'waterConsumption'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    washHooks<span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'getWater'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'è¿›æ°´500mL'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token number">500</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    washHooks<span class="token punctuation">.</span>first<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'wash'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">consumption</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ä»”ç»†æ‰æ“'</span> <span class="token operator">+</span> food <span class="token operator">+</span> <span class="token string">'å†åŠ ç‚¹æ°´ 50mL'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> consumption <span class="token operator">+</span> <span class="token number">50</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    washHooks<span class="token punctuation">.</span>second<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'getWater'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'è¿›æ°´600mLå†²æ´—'</span> <span class="token operator">+</span> food <span class="token operator">+</span> <span class="token string">' è¿‡æ°´å€’æ‰'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token number">600</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> firstConsumption <span class="token operator">=</span> washHooks<span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span>
    <span class="token keyword">const</span> secondConsumption <span class="token operator">=</span> washHooks<span class="token punctuation">.</span><span class="token function">second</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'æ€»ç”¨æ°´ '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>firstConsumption <span class="token operator">+</span> secondConsumption<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'mL'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  hooks<span class="token punctuation">.</span>makeFood<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'cut'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'åˆ‡'</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">)</span>
  hooks<span class="token punctuation">.</span>makeFood<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'cook'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ç…®'</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">)</span>
  
  hooks<span class="token punctuation">.</span>eatFood<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'eat'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'åƒ'</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">)</span>

  hooks<span class="token punctuation">.</span><span class="token function">makeFood</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span>
  hooks<span class="token punctuation">.</span><span class="token function">eatFood</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>food<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">takeFood</span><span class="token punctuation">(</span><span class="token string">'å¨ƒå¨ƒèœ'</span><span class="token punctuation">)</span>
</code></pre></div><p>æ‰§è¡Œç»“æœï¼š</p> <p><img src="/assets/img/tapable-2.bcddd7ac.png" alt="tapable-å¨ƒå¨ƒèœ"></p> <p>ç°è¦å®Œæˆåšèœã€åƒèœä¸¤ä¸ªä»»åŠ¡ï¼Œè€Œåšèœå¯ç»§ç»­ç»†åˆ†æˆè‹¥å¹²æ­¥éª¤ï¼Œé€šè¿‡tapçš„å›è°ƒä¸­æ‰§è¡Œå­tapæ–¹æ³•å®Œæˆæ•´ä¸ªä»»åŠ¡é“¾ã€‚è€Œwebpackçš„æ‰“åŒ…æµç¨‹ä¹Ÿä¸å¤–ä¹å¦‚æ­¤ï¼Œåªä¸è¿‡æ›´å¤æ‚ã€‚</p> <h3 id="æŠ½è±¡è¯­æ³•æ ‘"><a href="#æŠ½è±¡è¯­æ³•æ ‘" class="header-anchor">#</a> æŠ½è±¡è¯­æ³•æ ‘</h3> <p>æŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼‰ç®€ç§° ASTï¼Œæ‰§è¡Œæµç¨‹å¯è§ä¸‹å›¾ï¼š</p> <p><img src="/assets/img/ast-flow.ed6f518f.png" alt="ast-flow"></p> <ol><li>å›¾ä¸­codeå…ˆç»è¿‡parseè½¬æ¢æˆä¸€ä¸ªæ ‘çŠ¶æ•°æ®ç»“æ„</li> <li>æ¥ç€å¯¹æ ‘ä¸­èŠ‚ç‚¹è¿›è¡Œè½¬æ¢ï¼Œå›¾ä¸­å°†å¶å­èŠ‚ç‚¹å¯¹æ¢ä½ç½®</li> <li>å°†æ ‘çŠ¶ç»“æ„é€šè¿‡generateå†ç”Ÿæˆcode</li></ol> <p>è¯¸å¦‚è¯­æ³•æ£€æŸ¥ã€ä»£ç é”™è¯¯æç¤ºã€è‡ªåŠ¨è¡¥å…¨ç”šè‡³ä»£ç æ··æ·†å‹ç¼©ã€æ”¹å˜ä»£ç ç»“æ„ç­‰åŠŸèƒ½éƒ½èƒ½ä¾é ASTå®ç°ã€‚æˆ‘ä»¬æ¯å¤©ç”¨åˆ°çš„babelã€webpackã€eslintã€TypeScriptèƒŒåéƒ½éœ€è¦ä¸€å¥—å¯¹åº”çš„jsè§£æå™¨ã€‚</p> <p>è·å¾—æŠ½è±¡è¯­æ³•æ ‘çš„è¿‡ç¨‹ä¸ºï¼šä»£ç  =&gt; è¯æ³•åˆ†æ =&gt; è¯­æ³•åˆ†æ =&gt; AST
<code>è¯æ³•åˆ†æ</code>ï¼šæŠŠå­—ç¬¦ä¸²å½¢å¼çš„ä»£ç è½¬æ¢ä¸ºä»¤ç‰Œï¼ˆtokensï¼‰æµã€‚
<code>è¯­æ³•åˆ†æ</code>ï¼šæŠŠä¸€ä¸ªä»¤ç‰Œæµè½¬æ¢æˆ AST çš„å½¢å¼ã€‚è¿™ä¸ªé˜¶æ®µä¼šä½¿ç”¨ä»¤ç‰Œä¸­çš„ä¿¡æ¯æŠŠå®ƒä»¬è½¬æ¢æˆä¸€ä¸ª AST çš„è¡¨è¿°ç»“æ„ï¼Œè¿™æ ·æ›´æ˜“äºåç»­çš„æ“ä½œã€‚
å¦‚ä¸‹å›¾ï¼Œä»£ç ä¸ºä¸€ä¸ªç®€å•çš„å‡½æ•°å£°æ˜ã€‚è¯æ³•åˆ†æé˜¶æ®µï¼Œå°†ä»£ç ä½œä¸ºå­—ç¬¦ä¸²è¾“å…¥è·å¾—å…³é”®è¯ï¼Œå›¾ä¸­<code>function</code>ã€<code>square</code>ã€<code>(</code>ã€<code>)</code>ã€<code>{</code>ã€<code>}</code>ç­‰éƒ½è¢«è¯†åˆ«ä¸ºå…³é”®è¯ã€‚è¯­æ³•åˆ†æé˜¶æ®µï¼Œå¯¹å…³é”®è¯çš„ç»„åˆå½¢æˆä¸€ä¸ªä¸ªèŠ‚ç‚¹ï¼Œå¦‚n*nè¿™3ä¸ªå…³é”®è¯ç»„åˆæˆ<code>äºŒå…ƒè¡¨è¾¾å¼</code>ï¼Œå…³é”®è¯returnä¸äºŒå…ƒè¡¨è¾¾å¼ç»„åˆæˆ<code>returnè¯­å¥</code>ã€‚æœ€åç»„åˆæˆä¸€ä¸ª<code>å‡½æ•°å£°æ˜è¯­å¥</code>ã€‚</p> <p><img src="/assets/img/ast-func.744385ee.png" alt="img"></p> <p>å…¶å¯ä»¥è¢«è¡¨ç¤ºä¸ºå¦‚ä¸‹JSç»“æ„ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;ReturnStatement&quot;</span><span class="token punctuation">,</span>
      argument<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
        operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä½ ä¼šç•™æ„åˆ°ASTçš„æ¯ä¸€å±‚éƒ½æ‹¥æœ‰ç›¸åŒçš„ç»“æ„ï¼Œå…·ä½“è§ä¸‹æ–‡ã€‚</p> <h4 id="å¸¸è§è§£æå™¨"><a href="#å¸¸è§è§£æå™¨" class="header-anchor">#</a> å¸¸è§è§£æå™¨</h4> <p>åœ¨v8å¼•æ“ä¹‹å‰ï¼Œæœ€æ—©jså¼•æ“æ˜¯SpiderMonkeyã€‚jså¼•æ“åœ¨æ‰§è¡Œjsæ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šå…ˆå°†jsä»£ç è½¬æ¢æˆæŠ½è±¡è¯­æ³•æ ‘(AST)ã€‚æœ‰ä¸€å¤©ï¼Œä¸€ä½Mozillaå·¥ç¨‹å¸ˆåœ¨FireFoxä¸­å…¬å¼€äº†è¿™ä¸ªå°†ä»£ç è½¬æˆASTçš„è§£æå™¨Apiï¼Œåæ¥è¢«äººæ•´ç†åˆ°githubé¡¹ç›®<a href="https://github.com/estree/estree" target="_blank">ESTree</a>ï¼Œæ…¢æ…¢çš„æˆäº†ä¸šç•Œçš„è§„èŒƒã€‚ç°åœ¨æ‰€æœ‰çš„jsè§£æå™¨æˆ–ç¼–è¯‘å™¨åŸºæœ¬ä¸Šéƒ½ç»•ä¸å¼€å®ƒï¼Œä»¥ä¸‹æ˜¯å¸‚é¢ä¸Šå¸¸è§è§£æå™¨ï¼š</p> <ul><li><p><strong>uglify-js</strong></p> <p>ç”¨äºæ··æ·†å’Œå‹ç¼©ä»£ç ï¼Œç”±äºä¸€äº›åŸå› ï¼Œuglify-jsè‡ªå·±å†…éƒ¨å®ç°äº†ä¸€å¥—ASTè§„èŒƒï¼Œä¹Ÿæ­£å› ä¸ºå®ƒçš„ASTæ˜¯è‡ªåˆ›çš„ï¼Œä¸æ˜¯æ ‡å‡†çš„ESTreeï¼ŒES6ä»¥åæ–°è¯­æ³•çš„ASTéƒ½ä¸æ”¯æŒï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•å‹ç¼©æœ€æ–°çš„ES6çš„ä»£ç ï¼Œå¦‚æœéœ€è¦å‹ç¼©ï¼Œå¯ä»¥ç”¨ç±»ä¼¼babelè¿™æ ·çš„å·¥å…·å…ˆè½¬æ¢æˆES5ã€‚</p> <blockquote><p>uglify-jså¯ä»¥é€šè¿‡--acornæˆ–è€…--spidermonkeyæŒ‡å®šå¯¹åº”çš„parsing</p></blockquote></li> <li><p><strong>esprima</strong></p> <p>è¿™æ˜¯<strong>ç¬¬ä¸€ä¸ªç”¨JavaScriptç¼–å†™çš„ç¬¦åˆESTreeè§„èŒƒ</strong>çš„JavaScriptçš„è§£æå™¨ï¼Œåç»­å¤šä¸ªç¼–è¯‘å™¨éƒ½æ˜¯å—å®ƒçš„å½±å“ã€‚</p></li> <li><p><strong>acorn</strong></p> <p>acornæ€§èƒ½è¾ƒå¿«ï¼Œå’Œesprimaå¾ˆç±»ä¼¼ï¼Œè¾“å‡ºçš„ASTéƒ½æ˜¯ç¬¦åˆESTreeè§„èŒƒçš„ï¼Œæ˜¯ç›®å‰webpackçš„ASTè§£æå™¨ï¼Œå’Œesprimaä¸€æ ·ä¸ç›´æ¥æ”¯æŒJSXã€‚</p></li> <li><p><strong>@babel/parser(babylon)</strong></p> <p>babelå®˜æ–¹çš„è§£æå™¨ï¼Œæœ€åˆforkäºacornï¼Œåæ¥å®Œå…¨èµ°å‘äº†è‡ªå·±çš„é“è·¯ï¼Œä»babylonæ”¹åä¹‹åï¼Œå…¶æ„å»ºçš„æ’ä»¶ä½“ç³»éå¸¸å¼ºå¤§ã€‚</p></li> <li><p><strong>espree</strong></p> <p>eslintã€prettierçš„é»˜è®¤è§£æå™¨ï¼Œæœ€åˆforkäºesprimaçš„ä¸€ä¸ªåˆ†æ”¯ï¼ˆv1.2.2ï¼‰ï¼Œåæ¥å› ä¸ºES6çš„å¿«é€Ÿå‘å±•ï¼Œä½†esprimaçŸ­æ—¶é—´å†…åˆä¸æ”¯æŒï¼Œåé¢å°±åŸºäºacornå¼€å‘äº†ã€‚</p></li></ul> <p>è§£æå™¨å‡å‚è€ƒè‡ªæ–‡ç« ï¼š<a href="https://zhuanlan.zhihu.com/p/339555291" target="_blank">å¸¸è§parser</a>ã€‚</p> <h4 id="astè§„èŒƒ"><a href="#astè§„èŒƒ" class="header-anchor">#</a> ASTè§„èŒƒ</h4> <p>å‚è§<a href="https://juejin.cn/post/6844903798347939853" target="_blank">é«˜çº§å‰ç«¯åŸºç¡€-JavaScriptæŠ½è±¡è¯­æ³•æ ‘AST</a></p> <h4 id="æ“ä½œast"><a href="#æ“ä½œast" class="header-anchor">#</a> æ“ä½œAST</h4> <p>ASTåº”ç”¨çš„ä¸‰ä¸ªè¦ç‚¹ï¼š</p> <ul><li>éœ€è¦ä¸€ä¸ªè§£æå™¨ï¼Œå°†ä»£ç è½¬æ¢ä¸ºAST</li> <li>éœ€è¦ä¸€ä¸ªéå†å™¨ï¼Œèƒ½å¤Ÿéå†AST,å¹¶èƒ½å¤Ÿæ–¹ä¾¿çš„å¯¹ASTèŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹æŸ¥ç­‰æ“ä½œ</li> <li>éœ€è¦ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨ï¼Œèƒ½å¤Ÿå°†ASTè½¬æ¢ä¸ºä»£ç </li></ul> <p>å¸¸ç”¨æ»¡è¶³ä¸Šè¿°çš„å·¥å…·ä¸€ä¸ªæ˜¯<code>esprima</code>ï¼Œä¸€ä¸ªæ˜¯<code>babel</code>ï¼š</p> <p>esprimaçš„ä½¿ç”¨ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> esprima <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'esprima'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// code =&gt; ast</span>
<span class="token keyword">const</span> estraverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'estraverse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//astéå†</span>
<span class="token keyword">const</span> escodegen <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'escodegen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ast =&gt; code</span>
<span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">'const a = 1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ast <span class="token operator">=</span> esprima<span class="token punctuation">.</span><span class="token function">parseScript</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
estraverse<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">enter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//èŠ‚ç‚¹æ“ä½œ</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> transformCode <span class="token operator">=</span> escodegen<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>babelçš„ä½¿ç”¨ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//code =&gt; ast</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span> <span class="token comment">// astéå†ï¼ŒèŠ‚ç‚¹å¢åˆ æ”¹æŸ¥ï¼Œä½œç”¨åŸŸå¤„ç†ç­‰</span>
<span class="token keyword">const</span> generate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span> <span class="token comment">// ast =&gt; code</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç”¨äºASTèŠ‚ç‚¹çš„Lodashå¼å·¥å…·åº“,å„èŠ‚ç‚¹æ„é€ ã€éªŒè¯ç­‰</span>
<span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token string">'const a = 1'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">//èŠ‚ç‚¹æ“ä½œ</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> transformCode <span class="token operator">=</span> escodegen<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç›®å‰babelä¸ç®¡æ˜¯ä»ç”Ÿæ€ä¸Šè¿˜æ˜¯æ–‡æ¡£ä¸Šæ¯”esprimaè¦å¥½å¾ˆå¤šã€‚</p> <h3 id="webpack-4-æ„å»ºæµç¨‹"><a href="#webpack-4-æ„å»ºæµç¨‹" class="header-anchor">#</a> Webpack 4 æ„å»ºæµç¨‹</h3> <p>webpacké™¤äº†å¯ä»¥ç”¨å‘½ä»¤è¡Œå¯åŠ¨å¤–ï¼Œä¹Ÿæ”¯æŒNode APIæ–¹å¼å¼€å¯æ„å»ºç¼–è¯‘ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config.js'</span><span class="token punctuation">)</span>

<span class="token function">webpack</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err <span class="token punctuation">,</span>stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">||</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨è¿™é‡Œå¤„ç†é”™è¯¯</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'DONE'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>ä»¥ä¸‹æ˜¯webpackçš„æºç åŠæ‰€åšçš„é‡è¦æµç¨‹ï¼š</p> <p><img src="/assets/img/webpack-run.55bc224a.png" alt="webpack-run"></p> <p>å†æ¥çœ‹çœ‹compilerï¼Œå®ƒæœ‰ä¸ªé‡è¦çš„å±æ€§hooksï¼Œé‡Œé¢å­˜äº†è®¸å¤šéµå¾ªtapableæœºåˆ¶çš„hookï¼Œç”¨äºåƒä¸Šä¾‹ä¸­åšèœåƒèœèˆ¬çš„è°ƒç”¨ã€‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// æ‰€æœ‰é’©å­éƒ½æ˜¯ç”±`Tapable`æä¾›çš„ï¼Œä¸åŒé’©å­ç±»å‹åœ¨è§¦å‘æ—¶ï¼Œè°ƒç”¨æ—¶åºä¹Ÿä¸åŒ</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            beforeRun<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            run<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            done<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;stats&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
	
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token function-variable function">onCompiled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stats</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> stats<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterDone</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// åˆå§‹åŒ–æ¨¡å—å·¥å‚å¯¹è±¡</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
          <span class="token comment">// compilationè®°å½•æœ¬æ¬¡ç¼–è¯‘ä½œä¸šçš„ç¯å¢ƒä¿¡æ¯ </span>
          <span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compilation</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              compilation<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                  compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                      <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                          <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span>
                      <span class="token punctuation">}</span><span class="token punctuation">)</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨runå‡½æ•°ä¸­å‡ºç°çš„compileré’©å­æœ‰<code>beforeRun</code> --&gt; <code>run</code> --&gt; <code>done</code> --&gt; <code>afterDone</code>ï¼Œcompileå‡½æ•°ä¸­å‡ºç°çš„é’©å­æœ‰<code>beforeCompile</code> --&gt; <code>compile</code> --&gt; <code>make</code> --&gt; <code>afterCompile</code>ã€‚å³æ•´ä½“æµç¨‹ä¸­é‡è¦çš„é’©å­ä¸ºï¼š</p> <table><thead><tr><th>hook</th> <th>å¤‡æ³¨</th></tr></thead> <tbody><tr><td>before-run</td> <td>æ¸…é™¤ç¼“å­˜</td></tr> <tr><td>run</td> <td>æ³¨å†Œç¼“å­˜æ•°æ®é’©å­</td></tr> <tr><td>before-compile</td> <td>-</td></tr> <tr><td>compile</td> <td>å¼€å§‹ç¼–è¯‘</td></tr> <tr><td>make</td> <td>ä»å…¥å£åˆ†æä¾èµ–ä»¥åŠé—´æ¥ä¾èµ–æ¨¡å—ï¼Œåˆ›å»ºæ¨¡å—å¯¹è±¡</td></tr> <tr><td>build-module (compilation)</td> <td>æ¨¡å—æ„å»º</td></tr> <tr><td>seal (compilation)</td> <td>æ„å»ºç»“æœå°è£…ï¼Œä¸å¯å†æ›´æ”¹</td></tr> <tr><td>after-compile</td> <td>å®Œæˆæ„å»ºï¼Œç¼“å­˜æ•°æ®</td></tr> <tr><td>emit</td> <td>è¾“å‡ºåˆ°distç›®å½•</td></tr></tbody></table> <p>å…¶ä¸­build-moduleå’Œsealä¸ºcompilationä¸Šçš„hookã€‚</p> <blockquote><p>compiler &amp; compilation åŒºåˆ«</p> <p>compilerä»£è¡¨çš„æ˜¯ä¸å˜çš„webpackç¯å¢ƒï¼›
compilationä»£è¡¨çš„æ˜¯ä¸€æ¬¡ç¼–è¯‘ä½œä¸šï¼Œæ¯ä¸€æ¬¡çš„ç¼–è¯‘éƒ½å¯èƒ½ä¸åŒï¼›
ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š
compilerå°±åƒä¸€æ¡æ‰‹æœºç”Ÿäº§æµæ°´çº¿ï¼Œé€šä¸Šç”µåå®ƒå°±å¯ä»¥å¼€å§‹å·¥ä½œï¼Œç­‰å¾…ç”Ÿäº§æ‰‹æœºçš„æŒ‡ä»¤ï¼›
compliationå°±åƒæ˜¯ç”Ÿäº§ä¸€éƒ¨æ‰‹æœºï¼Œç”Ÿäº§çš„è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œä½†ç”Ÿäº§çš„æ‰‹æœºå¯èƒ½æ˜¯å°ç±³æ‰‹æœºä¹Ÿå¯èƒ½æ˜¯é­…æ—æ‰‹æœºã€‚ç‰©æ–™ä¸åŒï¼Œäº§å‡ºä¹Ÿä¸åŒã€‚</p></blockquote> <p>æ•´ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠæŠ½è±¡è¯­æ³•æ ‘çš„ç”Ÿæˆã€è½¬æ¢ã€ç¼–è¯‘ï¼š</p> <p><img src="/assets/img/webpack-flow.3567266f.png" alt="webpack-flow"></p> <h3 id="è¿·ä½ webpackçš„å®ç°"><a href="#è¿·ä½ webpackçš„å®ç°" class="header-anchor">#</a> è¿·ä½ Webpackçš„å®ç°</h3> <p>è§£ææ¨¡å—å‡½æ•°ï¼ˆè¯»å–æŸæ–‡ä»¶å¹¶è½¬æ¢ä¸ºes5ä»£ç ï¼Œå¹¶è¿”å›è¯¥æ¨¡å—çš„ä¾èµ–ä¿¡æ¯ï¼‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> moduleId <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">function</span> <span class="token function">getModuleInfo</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    sourceType<span class="token operator">:</span> <span class="token string">'module'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> node <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformFromAst</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    filename<span class="token punctuation">,</span>
    deps<span class="token punctuation">,</span>
    moduleId<span class="token operator">:</span> moduleId<span class="token operator">++</span><span class="token punctuation">,</span>
    code
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ›å»ºä¾èµ–å›¾ï¼ˆåŸºäºè§£ææ¨¡å—å‡½æ•°ä¸Šï¼Œæ ¹æ®å…¥å£è§£æå‡ºç¨‹åºä¾èµ–çš„æ‰€æœ‰æ¨¡å—ï¼Œå¹¶åˆ›å»ºæ˜ å°„ï¼‰ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createGraph</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entryModule <span class="token operator">=</span> <span class="token function">getModuleInfo</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">[</span>entryModule<span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> modules<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    module<span class="token punctuation">.</span>mapping <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    module<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">relativePath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> subModule <span class="token operator">=</span> <span class="token function">getModuleInfo</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
      module<span class="token punctuation">.</span>mapping<span class="token punctuation">[</span>relativePath<span class="token punctuation">]</span> <span class="token operator">=</span> subModule<span class="token punctuation">.</span>moduleId
      modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> modules
<span class="token punctuation">}</span>
</code></pre></div><p>åˆ›å»ºæ‰“åŒ…æ–‡ä»¶ï¼š</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> modules <span class="token operator">=</span> <span class="token string">''</span>
  graph<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    modules <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>moduleId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: [
        function (require, module, exports){
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
        },
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>mapping<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
      ],
    </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    (function(modules){
      function require(id){
        const [fn, mapping] = modules[id];
        function localRequire(relativePath){
          return require(mapping[relativePath]);
        }

        const module = {
          exports: {}
        }

        fn(localRequire, module, module.exports);

        return module.exports;
      }
      require(0);
    })({</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>modules<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">})
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
<span class="token comment">// å†™å…¥æ–‡ä»¶</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist/bundle.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="webpack-5-ä¸-webpack-4-å¯¹æ¯”"><a href="#webpack-5-ä¸-webpack-4-å¯¹æ¯”" class="header-anchor">#</a> Webpack 5 ä¸ Webpack 4 å¯¹æ¯”</h2> <p>å¾…ç¼–è¾‘</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/core/js/regex/" class="prev">
        JavaScriptæ­£åˆ™è¡¨è¾¾å¼
      </a></span> <span class="next"><a href="/framework/vue/source/">
        VUE2 æºç åˆ†æ
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.47ef6698.js" defer></script><script src="/assets/js/2.6d8ae55b.js" defer></script><script src="/assets/js/5.26e38a66.js" defer></script>
  </body>
</html>
